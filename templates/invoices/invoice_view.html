{% extends "base.html" %}
{% load static %}
{% block title %}Invoice #{{ invoice.number|default:invoice.id }}{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Invoice <small class="text-muted">#{{ invoice.number|default:invoice.id }}</small></h2>
    <div>

      <a href="{% url 'payments:payment_create_from_invoice' invoice.id %}" class="btn btn-primary">Add Payment</a>


      <!-- Edit (namespaced) -->
      <a href="{% url 'invoices:invoice_edit' invoice.id %}" class="btn btn-sm btn-outline-primary me-2">Edit</a>

      <!-- Download PDF (namespaced) -->
      <a href="{% url 'invoices:invoice_pdf' invoice.id %}" class="btn btn-sm btn-success me-2">Download PDF</a>

      <!-- Back to list (namespaced) -->
      <a href="{% url 'invoices:invoice_list' %}" class="btn btn-sm btn-outline-secondary me-2">Back</a>

      <!-- Print -->
      <button class="btn btn-sm btn-primary" id="btn-print">Print</button>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <h5>From</h5>
          <p>{{ invoice.company_name|default:"Your Company" }}</p>
          <p>{{ invoice.company_address }}</p>
        </div>
        <div class="col-md-6 text-end">
          <h5>To</h5>
          <p>{{ invoice.customer.name }}</p>
          <p>{{ invoice.customer.address }}</p>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Product</th>
              <th>Qty</th>
              <th>Unit Price</th>
              <th>Line Total</th>
            </tr>
          </thead>
          <tbody>
            {% for item in invoice.items.all %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ item.product.name }}</td>
              <td>{{ item.quantity }}</td>
              <td>₹ {{ item.unit_price|floatformat:2 }}</td>
              <td>₹ {{ item.line_total|floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center">No items</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="row mt-4">
        <div class="col-md-6"></div>
        <div class="col-md-6">
          <table class="table">
            <tr>
              <th>Subtotal</th>
              <td>₹ {{ invoice.subtotal|floatformat:2 }}</td>
            </tr>
            <tr>
              <th>Tax ({{ invoice.tax_percent }}%)</th>
              <td>₹ {{ invoice.tax_amount|floatformat:2 }}</td>
            </tr>
            <tr>
              <th>Discount</th>
              <td>₹ {{ invoice.discount_amount|floatformat:2 }}</td>
            </tr>
            <tr>
              <th>Total</th>
              <td><strong>₹ {{ invoice.grand_total|floatformat:2 }}</strong></td>
            </tr>
            <tr>
              <th>Paid</th>
              <td>₹ {{ invoice.amount_paid|floatformat:2 }}</td>
            </tr>
            <tr>
              <th>Balance</th>
              <td>₹ {{ invoice.balance|floatformat:2 }}</td>
            </tr>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
document.getElementById('btn-print')?.addEventListener('click', function(){
  window.print();
});
</script>

<style>
@media print {
  body * { visibility: hidden; }
  .container, .container * { visibility: visible; }
  .container { position: absolute; left: 0; top: 0; width: 100%; }
  a.btn, button { display: none !important; }
  .table { page-break-inside: avoid; }
}
.table td, .table th { vertical-align: middle; }
</style>
{% endblock %}
